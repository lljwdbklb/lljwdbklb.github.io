import{d as a,r as e,g as t,m as s,y as l,c as r,w as n,A as o,p as c,_ as u,q as i,i as d,o as f,a as h,h as g,e as v,u as w,t as m,x as p,B as _}from"./index-QjOnPgAD.js";import{m as y,g as x}from"./mqtt.CLjLDTK4.js";import{P as M}from"./config.CnoCz8Wu.js";import{_ as b}from"./plugin-vueexport-helper.BCo6x5W8.js";const D=b(a({__name:"realtime-monitor",setup(a){const b=e(!1),D=e(0),S=e("safe"),C=e("worn"),$=e(75),j=e("01:30"),A=e("00:00"),k=e([]),E=e(null);let F=null,P=!1;const L=t(()=>{if(0===k.value.length)return 0;const a=k.value.slice(-20),e=a.reduce((a,e)=>a+e,0);return Math.round(e/a.length*10)/10}),I=t(()=>{switch(S.value){case"safe":default:return"safe";case"warning":return"warning";case"danger":return"danger"}}),O=t(()=>{switch(S.value){case"safe":return"压力正常";case"warning":return"压力偏高";case"danger":return"压力异常";default:return"未知"}}),R=t(()=>{switch(C.value){case"worn":default:return"worn";case"not-worn":return"not-worn";case"abnormal":return"abnormal"}}),q=t(()=>{switch(C.value){case"worn":return"已佩戴";case"not-worn":return"未佩戴";case"abnormal":return"佩戴异常";default:return"未知"}}),z=t(()=>{const a=M,e=a.normalMax-a.normalMin;let t=(D.value-a.normalMin)/e*100;return t=Math.max(0,Math.min(100,t)),{left:`${t}%`}}),N=t(()=>({width:`${$.value}%`})),T=()=>{const a=M,e=a.normalMin,t=a.normalMax,s=Math.floor(Math.random()*(t-e+1))+e;D.value=s;const l=M;s>l.warningMax?S.value="danger":s<l.warningMin?S.value="warning":S.value="safe";const r=new Date,n=r.getHours().toString().padStart(2,"0"),o=r.getMinutes().toString().padStart(2,"0");A.value=`${n}:${o}`,k.value.length>50&&k.value.shift(),k.value.push(s),B()},B=()=>{try{if(!F)return P?void console.warn("图表正在初始化中，跳过本次更新"):(console.warn("图表实例未初始化，正在尝试重新初始化..."),P=!0,void G().then(a=>{P=!1,a?B():console.error("图表初始化失败，无法更新")}).catch(a=>{P=!1,console.error("图表初始化异常:",a)}));if(0===k.value.length)return;const a=k.value.slice(-20),e={categories:a.map((a,e)=>`#${e+1}`),series:[{name:"压力值",data:a,color:"#1890ff"}]};console.log("图表实例方法:",Object.keys(F)),"function"==typeof F.updateData?(console.log("使用updateData方法更新图表"),F.updateData(e)):"function"==typeof F.setData?(console.log("使用setData方法更新图表"),F.setData(e)):"function"==typeof F.draw?(console.log("使用draw方法更新图表"),F.draw(e)):console.error("图表实例缺少更新数据的方法")}catch(a){console.error("更新图表失败:",a)}},G=async()=>{if(P)return console.warn("图表正在初始化中，跳过本次初始化"),!1;P=!0;try{console.log("开始初始化图表..."),await o();const a=await new Promise((a,e)=>{if(E.value){const t=E.value.canvas||E.value;t?a({node:t,width:t.width||300,height:t.height||200}):e(new Error("无法从ref获取canvas元素"))}else{c().select("#pressureChart").fields({node:!0,size:!0}).exec(t=>{Array.isArray(t)&&t.length>0&&t[0]&&t[0].node?a({node:t[0].node,width:t[0].width||300,height:t[0].height||200}):e(new Error("无法获取canvas元素"))})}});console.log("canvas查询结果:",a);const e=a.node,t=e.getContext("2d");if(!t)throw new Error("无法获取canvas 2D上下文");let s=a.width,l=a.height;0!==s&&0!==l||(console.warn("Canvas尺寸为0，使用默认尺寸"),s=300,l=200,e.width=s,e.height=l),console.log("Canvas信息:",{width:s,height:l,ctx:!!t});const r=k.value.length>0?k.value.slice(-20):Array.from({length:20},(a,e)=>Math.floor(20*Math.random())+10),n={categories:r.map((a,e)=>`#${e+1}`),series:[{name:"压力值",data:r,color:"#1890ff"}]};console.log("图表初始化数据:",n);const d=await u(()=>import("assets/qiun-ucharts/u-charts.min.js"),[],import.meta.url),f=d.default||d;if(console.log("uCharts模块导入结果:",typeof f),"function"!=typeof f)throw new Error("uCharts导入失败，不是一个构造函数");const h={context:t,type:"line",fontSize:12,legend:!1,dataLabel:!1,dataPointShape:!1,background:"#FFFFFF",pixelRatio:i().pixelRatio,categories:n.categories,series:n.series,animation:!0,xAxis:{disableGrid:!0,axisLine:!1,axisLabel:!1},yAxis:{gridType:"dash",dashLength:2,splitNumber:5,min:M.normalMin,max:M.normalMax},width:s,height:l,extra:{line:{type:"straight",width:2}}};return console.log("准备创建图表实例，配置:",JSON.stringify(h,(a,e)=>"context"===a?"[CanvasRenderingContext2D]":e)),F=new f(h),console.log("图表实例创建成功:",F),console.log("图表实例方法:",Object.keys(F)),!0}catch(a){return console.error("初始化图表失败:",a),F=null,!1}finally{P=!1}};let H;return s(async()=>{y(),b.value=x();try{await G(),console.log("图表初始化成功")}catch(e){console.error("图表初始化失败:",e)}T();let a=Date.now();H=setInterval(()=>{if(T(),Math.random()>.98&&(b.value=!b.value),Math.random()>.97){const e=["worn","not-worn","abnormal"],t=e[Math.floor(Math.random()*e.length)];"worn"!==C.value&&"worn"===t&&(a=Date.now()),C.value=t}if("worn"===C.value){const e=Date.now()-a,t=Math.floor(e/36e5),s=Math.floor(e%36e5/6e4);j.value=`${t.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`}Math.random()>.99&&($.value=Math.max(0,$.value-1))},2e3)}),l(()=>{H&&clearInterval(H)}),(a,e)=>{const t=d;return f(),r(t,{class:"realtime-monitor-page"},{default:n(()=>[h(t,{class:"page-header"},{default:n(()=>[b.value?(f(),r(t,{key:0,class:"monitor-status"},{default:n(()=>[h(t,{class:"status-dot connected"}),h(t,{class:"status-text"},{default:n(()=>[v("实时更新")]),_:1})]),_:1})):g("",!0)]),_:1}),h(t,{class:"main-content"},{default:n(()=>[h(t,{class:"pressure-section"},{default:n(()=>[h(t,{class:"pressure-header"},{default:n(()=>[w("h2",{class:"section-title"},"实时压力值"),h(t,{class:"update-time"},{default:n(()=>[v("最后更新: "+m(A.value),1)]),_:1})]),_:1}),h(t,{class:"pressure-display"},{default:n(()=>[h(t,{class:"pressure-value"},{default:n(()=>[v(m(D.value),1)]),_:1}),h(t,{class:"pressure-unit"},{default:n(()=>[v("kPa")]),_:1})]),_:1}),h(t,{class:p(["pressure-status",I.value])},{default:n(()=>[h(t,{class:"status-icon"}),h(t,{class:"status-text"},{default:n(()=>[v(m(O.value),1)]),_:1})]),_:1},8,["class"]),h(t,{class:"pressure-range"},{default:n(()=>[h(t,{class:"range-bar"},{default:n(()=>[h(t,{class:"range-section safe"}),h(t,{class:"range-section warning"}),h(t,{class:"range-section danger"})]),_:1}),h(t,{class:"range-indicator",style:_(z.value)},null,8,["style"])]),_:1})]),_:1}),h(t,{class:"wear-info-section"},{default:n(()=>[w("h2",{class:"section-title"},"佩戴信息"),h(t,{class:"info-cards"},{default:n(()=>[h(t,{class:"info-card"},{default:n(()=>[h(t,{class:"card-label"},{default:n(()=>[v("佩戴状态")]),_:1}),h(t,{class:p(["card-value",R.value])},{default:n(()=>[v(m(q.value),1)]),_:1},8,["class"])]),_:1}),h(t,{class:"info-card"},{default:n(()=>[h(t,{class:"card-label"},{default:n(()=>[v("电池电量")]),_:1}),h(t,{class:"card-value battery"},{default:n(()=>[h(t,{class:"battery-icon"},{default:n(()=>[h(t,{class:"battery-fill",style:_(N.value)},null,8,["style"])]),_:1}),h(t,{class:"battery-percent"},{default:n(()=>[v(m($.value)+"%",1)]),_:1})]),_:1})]),_:1}),h(t,{class:"info-card"},{default:n(()=>[h(t,{class:"card-label"},{default:n(()=>[v("今日佩戴")]),_:1}),h(t,{class:"card-value"},{default:n(()=>[v(m(j.value),1)]),_:1})]),_:1}),h(t,{class:"info-card"},{default:n(()=>[h(t,{class:"card-label"},{default:n(()=>[v("压力平均值")]),_:1}),h(t,{class:"card-value"},{default:n(()=>[v(m(L.value)+" kPa",1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})]),_:1})}}}),[["__scopeId","data-v-85803938"]]);export{D as default};
